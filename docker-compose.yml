services:
  dind:
    image: docker:27-dind
    privileged: true
    environment:
      DOCKER_TLS_CERTDIR: ""
    command: [ "--host=tcp://0.0.0.0:2375", "--host=unix:///var/run/docker.sock" ]
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:2375/version" ]
      interval: 2s
      timeout: 2s
      retries: 10
    volumes:
      - dind-storage:/var/lib/docker
      - shared-code:/code   # üëà —à–∞—Ä–∏–º —Ç–æ–º –¥–ª—è –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤

  compiler-api:
    build: .
    depends_on:
      dind:
        condition: service_healthy
    environment:
      DOCKER_HOST: tcp://dind:2375
      CODE_DIR: /code        # üëà –≥–æ–≤–æ—Ä–∏–º API –∫–ª–∞—Å—Ç—å —Å—é–¥–∞ —Ñ–∞–π–ª—ã
    volumes:
      - shared-code:/code    # üëà —Ç–æ—Ç –∂–µ —Ç–æ–º –ø–æ–¥–∫–ª—é—á–∞–µ–º —Å—é–¥–∞
    ports:
      - "8080:8080"

volumes:
  dind-storage:
  shared-code:
